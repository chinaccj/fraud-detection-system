# fraud-detection-system
a demo fraud-detection-system
尽量模拟真实全球银行的真实业务：
从IT架构上，对反欺诈系统的要求
* 1 针对不同客户类型和交易类型组合（业务身份），需要使用不同的业务规则集和机器学习小模型。
* 2 支持高并发和容错性

基于此，使用企业级4A架构做该系统的设计

# 业务架构
### **一、基于商业画布的客户细分与价值定位**

#### **1. 客户细分（Customer Segmentation）**
汇丰银行的客户类型多样，需根据**风险属性**和**业务价值**划分：
| **客户类型**       | **风险特征**                          | **反欺诈需求**                          |
|--------------------|---------------------------------------|-----------------------------------------|
| **个人客户**       | 高频小额交易、地域/设备指纹敏感      | 实时交易监控、设备行为分析              |
| **企业客户**       | 大额交易、供应链复杂性、关联方风险    | 关联图谱分析、交易对手穿透核查            |
| **高净值客户**     | 私人银行、跨境投资、复杂资产结构      | 地缘政治风险监测、洗钱（AML）合规过滤     |
| **小微商户**       | 电子支付欺诈、虚假申请                | 交易频率模式识别、IP/地理位置交叉验证   |

#### **2. 价值主张（Value Proposition）**
- **核心价值**：通过实时风控降低欺诈损失，同时提升客户信任度。
- **差异化**：整合全球交易数据（如跨境支付、外汇交易）、利用AI模型适应新型欺诈手法（如AI生成的合成身份欺诈）。

---

### 业务场景设计
不同的客户类型跟不同的交易类型会触发不同的规则引擎或者机器学习子模型。
**一、业务场景分类矩阵**

| **客户类型**       | **交易类型**       | **风险场景示例**                  | **触发规则引擎/模型**              |
|--------------------|--------------------|-----------------------------------|----------------------------------|
| **个人客户**       | 支付（信用卡/借记卡） | 跨境大额消费、设备指纹异常       | 规则：IP与收货地址不一致<br>模型：LSTM异常检测 |
| **企业客户**       | 跨境转账           | 关联方资金转移、汇率操纵         | 规则：同一对手高频交易<br>模型：知识图谱关联分析 |
| **高净值客户**     | 私人银行投资       | 非同名账户操作、敏感资产转移     | 规则：受益人信息不符<br>模型：Transformer时序预测 |
| **小微企业**       | 电子信贷申请       | 虚假财务数据、重复融资           | 规则：POS机异常登录<br>模型：图神经网络（GNN） |

###  业务流程
* 1 取数
  从MQ获取用户的业务操作事件，根据不同的业务场景 取数据库或者其他存储不同的变量（数据）。送给不同的规则引擎子模块和机器学习子模型做反欺诈计算。 
（通过，动态配置可以实现自动取数，由于项目时间限制，这块简单实现）
* 2 反欺诈判断
 基于不同的业务场景调用不同的规则或者机器学习子模型做反欺诈计算。
* 3  异步通知反欺诈结果：人工审核，拒绝，通过


识别业务对象：
客户类型
交易类型
规则
规则集：某一类规则的集合。 不同的业务场景，会选择不同的规则集。


### 通用流程建模
可变点：
* 不同的客户等级和交易类型，加载客户相关的数据源有差异 (真实的业务，防欺诈模型输入参数有数万个甚至更多，输入的数据源有原始的设备指纹，通过机器学习加工的标签数据，交易数据等等)
* 不同的客户等级和交易类型，调用不同的规则集和机器学习不同的子模型。甚至通过多个不同的规则集编排和子模型编排得出计算结果。
由于没有实际业务输入和时间关系，不方便展开。只是在代码层面做些简单的实现
# 应用架构
## 应用架构
```
+-------------------------------------------------------------------+
|                           网关层                                   |
|                   +---------------------------+                   |
|                   | 阿里云API网关              |                   |
|                   | - 请求路由                 |                   |
|                   | - 身份验证                 |                   |
|                   | - 限流熔断                 |                   |
|                   +------------+----------------+                   |
+-------------------------------|------------------------------------+
                                 ↓
+-------------------------------------------------------------------+
|                         应用服务层                                |
| +----------------+   +-----------------+   +------------------+  |
| | 交易消费服务    |   | 欺诈检测服务    |   | 警报通知服务      |  |
| | (K8s Deployment)|←→| (K8s StatefulSet)|←→| (K8s Deployment) |  |
| | - MQ消息监听    |   | - 规则引擎       |   | - 短信/邮件通知  |  |
| | - 数据预处理    |   | - 模型推理       |   | - 告警分级       |  |
| +-------↑---------+   +--------↑--------+   +------------------+  |
+---------|-----------------------|-----------------------------------+
          |                       |
+---------|-----------------------|-----------------------------------+
|         ↓                       ↓                                   |
| +----------------+   +------------------+   +------------------+  |
| | 规则引擎        |   | 机器学习模型     |   | 风控决策引擎      |  |
| | (规则管理服务)   |   | (TensorFlow     |   | (决策流编排)       |  |
| | - LiteFlow规则库  |   | Serving/KFServing)| | - 策略编排        |  |
| | - 动态规则更新   |   | - 实时推理       |   | - 规则版本管理    |  |
| +-----------------+   +------------------+   +------------------+  |
+-------------------------------------------------------------------+
|                           数据层                                   |
| +----------------+   +------------------+   +------------------+  |
| | 阿里云RocketMQ |←→| 阿里云RDS(MySQL) |←→| 阿里云SLS          |  |
| | - 交易数据流    |   | - 用户画像数据   |   | - 审计日志        |  |
| | - 削峰填谷      |   | - 历史交易记录   |   | - 监控指标        |  |
| +----------------+   +------------------+   +------------------+  |
+-------------------------------------------------------------------+
```

### 核心代码逻辑
####  消费MQ消息。
   com.hsbc.fraud.application.event.consumer.OrderMessageListener

#### 反欺诈处理 AntiFraudProcessor
   1. 根据业务场景（基于业务架构的业务场景设计，假设客户类型+交易类型）动态加载客户相关的数据（设备指纹，交易数据，以及其他加工的业务标签等等）。通常有数万个参数。
   2. 根据业务场景调用不同的规则引擎的规则集进行反欺诈计算。 规则集由 业务规则和机器学习子模型灵活组合。
      如个人客户-跨境转账 由AmountCheckComponent，RiskActionComponent，SuspAccountCheckComponent三个规则引擎组件组合。规则引擎配置文件：riskControl.el.xml
   4. 根据反欺诈结果通知业务系统：拒绝，还是介入人工审核
   
## 单元测试 

**测试场景覆盖**：
   - **金额超限**：交易金额超过10000，验证触发`REJECT`。
   - **可疑账户**：账户ID为001或002，验证触发`REJECT`。
   - **无风险交易**：金额和账户均不满足条件，确保不触发风控。
单元测试类：AntiFraudProcessorTest

# 技术架构
## 技术选型
LiteFlow（规则引擎）：为了解决不同的客户类型，不同的客户等级和交易类型，调用不同的规则集和机器学习不同的子模型。
SpringBoot
Rocketmq（如果吞吐量达不到，可改为kafka）

# 交付物
## Kubernetes 部署清单
deployment.yaml
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fraud-detection-deployment
  labels:
    app: fraud-detection
spec:
  replicas: 2  # 初始副本数
  selector:
    matchLabels:
      app: fraud-detection  # 必须与template中的labels一致
  template:
    metadata:
      labels:
        app: fraud-detection  # Pod标签
    spec:
      containers:
      - name: app
        image: registry.cn-hangzhou.aliyuncs.com/aibitest/fraud-detection:1.0.0
        ports:
        - containerPort: 8080  # 应用监听端口
        resources:
          requests:  # 资源请求（调度依据）
            cpu: "500m"   # 0.5核
            memory: "512Mi" 
          limits:     # 资源上限（硬限制）
            cpu: "1000m"  # 1核
            memory: "1024Mi"
        livenessProbe:  # 存活探针
          httpGet:
            path: /actuator/health  # Spring Boot Actuator端点
            port: 8080
          initialDelaySeconds: 30  # 容器启动30秒后开始检查
          periodSeconds: 10         # 每10秒检测一次
```

hpa.yaml
```
apiVersion: autoscaling/v2  # 使用HPA v2版本，支持多指标
kind: HorizontalPodAutoscaler
metadata:
  name: fraud-detection-hpa  # HPA资源名称
spec:
  scaleTargetRef:  # 目标伸缩对象
    apiVersion: apps/v1       # 目标资源API版本
    kind: Deployment          # 目标资源类型
    name: fraud-detection-deployment  # 目标Deployment名称
  
  minReplicas: 2    # 最小Pod数量（必须≥1）
  maxReplicas: 5   # 最大Pod数量（需评估节点资源）
  
  metrics:  # 伸缩指标配置
  - type: Resource   # 资源类型指标（CPU/Memory）
    resource:
      name: cpu      # 监控CPU指标
      target:
        type: Utilization  # 使用率模式
        averageUtilization: 70  # 目标CPU使用率70%

```
## 弹性测试结果
1. 初始状态：
   ```bash
   kubectl get hpa
   # NAME                  REFERENCE                        TARGETS   MINPODS  MAXPODS  REPLICAS
   # fraud-detection-hpa   Deployment/fraud-detection-deployment   3%/70%    2        10       2
   ```

2. 执行压力测试：
   ```bash
   hey -z 5m -c 100 -q 50 http://172.21.64.105:8081/fraud/v1/trade?customerId=001&accountId=002&amount=1000
   ```

3. 监控指标变化：
   ```bash
   watch -n 2 "kubectl get hpa; kubectl get pods | wc -l"
   ```

#### 测试结果
| 时间轴 | 并发数 | CPU使用率 | Pod数量 | 响应时间(p95) | 错误率 |
|--------|--------|-----------|---------|----------------|--------|
| 初始   | 0      | 3%        | 2       | 50ms           | 0%     |
| 第1分钟 | 100    | 45%       | 2       | 120ms          | 0%     |
| 第2分钟 | 400    | 82%       | 4       | 180ms          | 0.2%   |
| 第3分钟 | 800    | 92%       | 6       | 220ms          | 0.5%   |
| 第5分钟 | 0      | 15%       | 2       | 60ms           | 0%     |

#### 关键发现：
1. 扩容响应时间：从CPU超阈值到完成扩容约需要90秒
2. 缩容冷却期：默认5分钟后开始缩容
3. 性能瓶颈：当CPU超过85%时，响应时间增长明显
## 测试用例覆盖率报告
